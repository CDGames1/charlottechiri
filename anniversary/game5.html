<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Charchi 2.0</title>
<style>
/* ===========================
   THEME & LAYOUT
   =========================== */
:root{
  --bg-a:#0f2027; --bg-b:#2c5364;
  --card-w:86px; --card-h:126px;
  --discard-w:68px; --discard-h:100px;
  --accent:#ffd166;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg-a),var(--bg-b));color:#fff;overflow:hidden}

/* STARTUP */
#startup{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:60;transition:opacity .8s}
#flashImg{width:230px;height:230px;border-radius:14px;object-fit:cover;box-shadow:0 12px 30px rgba(0,0,0,.7),0 0 40px rgba(255,255,255,.04);animation:imgPulse .9s linear infinite}
@keyframes imgPulse{0%{filter:brightness(.55)}50%{filter:brightness(1.05)}100%{filter:brightness(.6)}}
#startupTitle{margin-top:18px;font-weight:800;font-size:36px;letter-spacing:1px;opacity:0;transform:translateY(10px);color:var(--accent);text-shadow:0 3px 18px rgba(0,0,0,.6)}

/* APP shell */
#app{display:flex;flex-direction:column;height:100vh;width:100vw;align-items:center;justify-content:space-between;padding:16px 20px;gap:10px;position:relative}
.header{width:100%;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.4)}
.brand h1{margin:0;font-size:18px}
.controls{display:flex;gap:8px;align-items:center}

/* PLAY AREA */
.board{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:1200px}
.play-area{width:100%;display:flex;justify-content:center;align-items:center;gap:26px;padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
.pile{display:flex;flex-direction:column;align-items:center;gap:8px}
.pile .label{font-size:12px;color:#dfeff3;opacity:.9}

/* PILE CARDS */
.pile-card{width:var(--card-w);height:var(--card-h);border-radius:10px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.45);position:relative;background:#111;border:2px solid rgba(255,255,255,.03)}
.pile-card img{width:100%;height:100%;object-fit:cover;display:block}

/* DISCARD smaller & with badge */
#discardWrap{width:var(--discard-w);height:var(--discard-h);transform:scale(0.96)}
#discardWrap .pile-card{width:100%;height:100%;border-radius:10px;overflow:hidden;position:relative}
#discardWrap img{width:100%;height:100%;object-fit:cover}
#discardBadge{position:absolute;right:6px;bottom:6px;padding:6px 8px;border-radius:8px;font-weight:800;font-size:14px;text-transform:uppercase;box-shadow:0 6px 20px rgba(0,0,0,.45)}

/* CARD / HAND */
.player-area{width:100%;display:flex;flex-direction:column;align-items:center;gap:8px}
.hand{display:flex;gap:10px;align-items:flex-end;padding:8px;min-height:140px;overflow-x:auto;width:100%}
.card{width:var(--card-w);height:var(--card-h);border-radius:10px;position:relative;flex:0 0 auto;cursor:pointer;transition:transform .18s cubic-bezier(.2,.9,.2,1),box-shadow .18s}
.card img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.card:hover{transform:translateY(-10px) scale(1.04);box-shadow:0 18px 48px rgba(0,0,0,.6)}
.card.playable{outline:3px solid rgba(255, 220, 100, .95);box-shadow:0 22px 60px rgba(255,220,100,.06)}

.overlay{position:absolute;left:8px;top:8px;padding:6px 8px;border-radius:8px;font-weight:800;font-size:18px;text-shadow:0 1px 2px rgba(0,0,0,.7)}

/* COMPUTER HAND (face-down) */
.computer-hand{display:flex;gap:8px;align-items:center;height:110px;overflow:hidden;padding:8px}
.computer-card{width:56px;height:84px;border-radius:8px;background:#0c1216;border:2px solid rgba(255,255,255,.02);box-shadow:0 6px 18px rgba(0,0,0,.5);background-size:cover;background-position:center}

/* STATUS & ACTIONS */
.statusbar{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px;width:100%}
.status{padding:8px 12px;border-radius:10px;background:rgba(0,0,0,.22);font-weight:700;color:#fff}
.controls button{background:linear-gradient(90deg,#ff758c,#ff7eb3);border:none;color:#fff;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.38)}
.controls .small{padding:6px 8px;font-size:14px}

/* MODALS */
#colorPicker{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:200;background:#07121a;padding:10px;border-radius:10px;display:none;box-shadow:0 18px 60px rgba(0,0,0,.6)}
.colorBtn{width:52px;height:52px;border-radius:8px;margin:6px;border:3px solid rgba(255,255,255,.06);cursor:pointer;display:inline-block}

/* END OVERLAY */
#endOverlay{position:fixed;inset:0;display:none;z-index:220;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.85))}
.endBox{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));padding:24px;border-radius:12px;text-align:center;color:#fff}
.endBox h2{margin:0 0 8px 0}

/* responsive tweaks */
@media (max-width:720px){
  :root{--card-w:72px;--card-h:106px;--discard-w:56px;--discard-h:82px}
  #flashImg{width:160px;height:160px}
  .brand h1{font-size:16px}
}
</style>
</head>
<body>

<!-- audio element for CharChi sound -->
<audio id="charchiAudio" src="CharChi.mp3" preload="auto"></audio>

<!-- STARTUP SLIDESHOW -->
<div id="startup" aria-hidden="false">
  <img id="flashImg" src="photos/photo1.jpg" alt="slideshow image">
  <div id="startupTitle">10th Month Anniversary Game</div>
</div>

<!-- APP -->
<div id="app" style="display:none">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="logo"><img src="photos/photo1.jpg" alt="logo" style="width:100%;height:100%;object-fit:cover"></div>
      <div>
        <h1>10th Month Anniversary game improved CharChi</h1>
        <div style="font-size:12px;color:#d7e6ea">Charchi 2.0</div>
      </div>
    </div>

    <div class="controls">
      <!-- Restored Turn element so JS can update it -->
      <div style="font-size:13px;color:#e6f0f3">Turn: <strong id="turnTag">My YABBB xx</strong></div>

      <button id="btnNew">New Game xx</button>
      <!-- rules button left as a visual placeholder but does nothing -->
      <button id="btnRules" class="small" onclick="location.href='game5_multiplayer.html'">
  Multiplayer
</button>
    </div>
  </div>

  <!-- PLAY AREA -->
  <div class="board">
    <div class="computer-hand" id="computerHand" title="Computer's cards (face-down)"></div>

    <div class="play-area">
      <div class="pile">
        <div class="label">Draw Pill xx</div>
        <div class="pile-card" id="drawPile" title="Draw pile xxxxx (click to draw)">
          <img src="photos/photo1.jpg" alt="draw">
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="label">Card pile thing xx</div>
        <div id="discardWrap">
          <div class="pile-card" id="discard"></div>
        </div>
      </div>

      <div style="width:140px;text-align:center">
        <div style="font-size:12px;color:#cfe9ee">amount of cards left xx</div>
        <div id="deckCount" style="font-weight:800;font-size:20px">0</div>
      </div>
    </div>

    <div class="player-area" style="width:100%;max-width:1200px">
      <div style="font-size:13px;color:#cfe9ee">Your cardsss xx</div>
      <div class="hand" id="playerHand"></div>

      <div class="statusbar">
        <div class="status" id="statusText">Click a highlighted card to play it, or click the draw pile to draw.</div>
        <div style="flex:1"></div>
        <div>
          <!-- this button now plays CharChi.mp3 -->
          <button id="btnSayUNO" class="small">call CharChi</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- COLOR PICKER (for wildcard) -->
<div id="colorPicker">
  <div style="color:#d9f0f6;font-weight:700;margin-bottom:8px">Choose color</div>
  <div style="display:flex">
    <div class="colorBtn" data-color="red" style="background:linear-gradient(180deg,#ff7b7b,#e64545)"></div>
    <div class="colorBtn" data-color="yellow" style="background:linear-gradient(180deg,#ffe08a,#ffd166)"></div>
    <div class="colorBtn" data-color="green" style="background:linear-gradient(180deg,#85ffb7,#29be6a)"></div>
    <div class="colorBtn" data-color="blue" style="background:linear-gradient(180deg,#8fb6ff,#1e7bff)"></div>
  </div>
</div>

<!-- ENDGAME -->
<div id="endOverlay">
  <div class="endBox">
    <h2 id="endTitle">You Win xx yahhhhh xx</h2>
    <div id="endSubtitle" style="opacity:.9;margin-top:8px">Congrats</div>
    <button id="btnReplay" style="margin-top:12px;padding:10px 14px;border-radius:8px;border:none;background:#ffd166;color:#102027;font-weight:800">Play charchi again?</button>
  </div>
</div>

<script>
/* ===========================
   Config & Game State
   =========================== */
const TOTAL_PHOTOS = 28;
const START_HAND = 7;
const COLORS = ['red','yellow','green','blue'];
const ACTION_TYPES = ['skip','reverse','draw2'];

let deck = [];
let discard = { pile: [], currentColor: null }; // pile: array, top at end
let playerHand = [];
let computerHand = [];
let currentPlayer = 'player';
let direction = 1;
let isGameOver = false;
let pendingWildPlay = null;

/* DOM refs */
const startup = document.getElementById('startup');
const flashImg = document.getElementById('flashImg');
const startupTitle = document.getElementById('startupTitle');
const app = document.getElementById('app');

const playerHandDiv = document.getElementById('playerHand');
const computerHandDiv = document.getElementById('computerHand');
const drawPileDiv = document.getElementById('drawPile');
const discardDiv = document.getElementById('discard');
const deckCount = document.getElementById('deckCount');
const turnTag = document.getElementById('turnTag'); // now present in HTML
const statusText = document.getElementById('statusText');
const colorPicker = document.getElementById('colorPicker');
const endOverlay = document.getElementById('endOverlay');
const endTitle = document.getElementById('endTitle');
const endSubtitle = document.getElementById('endSubtitle');

/* CharChi audio element */
const charchiAudio = document.getElementById('charchiAudio');

/* Buttons */
document.getElementById('btnNew').addEventListener('click', startNewGame);
document.getElementById('btnReplay').addEventListener('click', startNewGame);
/* rules button left as no-op */
document.getElementById('btnRules').addEventListener('click', ()=> { /* rules removed */ });

/* IMPORTANT: replaced UNO speech with CharChi.mp3 playback */
document.getElementById('btnSayUNO').addEventListener('click', playCharChi);

/* color buttons */
document.querySelectorAll('.colorBtn').forEach(b=>{
  b.addEventListener('click', ()=> {
    const col = b.dataset.color;
    hideColorPicker();
    if(pendingWildPlay){
      playWildFinalize(pendingWildPlay.card, pendingWildPlay.from, col, pendingWildPlay.idx);
      pendingWildPlay = null;
    }
  });
});

/* clicking draw pile */
drawPileDiv.addEventListener('click', ()=>{
  if(currentPlayer !== 'player' || isGameOver) return;
  playerDraw(1,true);
});

/* ===========================
   Audio helpers (WebAudio)
   =========================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq=440, time=0.08, type='sine', gain=0.12){
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.value = gain;
  o.start(); o.stop(audioCtx.currentTime + time);
}
function soundPlayCard(){ playTone(880,0.06,'sine',0.08); }
function soundDraw(){ playTone(420,0.08,'triangle',0.08); }
function soundSpecial(){ playTone(560,0.12,'square',0.12); }

/* speech helper (kept for other messages like win/lose) */
function speak(text){ 
  // stop audio if it's playing, then optionally speak
  try { if(charchiAudio && !charchiAudio.paused) charchiAudio.pause(); } catch(e){}
  if(window.speechSynthesis){
    const u=new SpeechSynthesisUtterance(text);
    u.rate=1.05;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
}

/* Play CharChi.mp3 (played when user clicks the CharChi button) */
function playCharChi(){
  // stop speechSynthesis so it doesn't overlap
  if(window.speechSynthesis) window.speechSynthesis.cancel();
  if(!charchiAudio) return;
  charchiAudio.pause();
  charchiAudio.currentTime = 0;
  // attempt to play; some browsers require user gesture (we're inside click handler)
  charchiAudio.volume = 0.95;
  charchiAudio.play().catch(err=>{
    // If play is blocked, fall back to a friendly console message.
    console.warn('Could not play CharChi.mp3 — user gesture required or file missing.', err);
  });
}

/* ===========================
   Deck / Card creation
   Card object: { id, kind:'number'|'action'|'wild'|'wildDraw4', color|null, value, img }
   =========================== */
function buildDeck(){
  deck = []; let id=1;
  // For each color: 0 (one), 1..9 (two copies), 2 action copies
  for(const color of COLORS){
    deck.push({id:id++, kind:'number', color, value:0, img:`photos/photo${((id-2)%TOTAL_PHOTOS)+1}.jpg`});
    for(let n=1;n<=9;n++){
      for(let copy=0; copy<2; copy++){
        deck.push({id:id++, kind:'number', color, value:n, img:`photos/photo${((id-2)%TOTAL_PHOTOS)+1}.jpg`});
      }
    }
    for(const action of ACTION_TYPES){
      for(let c=0;c<2;c++){
        deck.push({id:id++, kind:'action', color, value:action, img:`photos/photo${((id-2)%TOTAL_PHOTOS)+1}.jpg`});
      }
    }
  }
  for(let i=0;i<4;i++) deck.push({id:id++, kind:'wild', color:null, value:'wild', img:`photos/photo${((id-2)%TOTAL_PHOTOS)+1}.jpg`});
  for(let i=0;i<4;i++) deck.push({id:id++, kind:'wildDraw4', color:null, value:'wildDraw4', img:`photos/photo${((id-2)%TOTAL_PHOTOS)+1}.jpg`});
  shuffle(deck);
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
function drawFromDeck(n=1){
  const out=[];
  for(let i=0;i<n;i++){
    if(deck.length===0){
      // replenish from discard except top
      if(discard.pile.length>1){
        const top = discard.pile.pop();
        const rest = discard.pile.splice(0);
        deck = rest;
        discard.pile = [top];
        shuffle(deck);
      } else break;
    }
    const c = deck.pop(); if(c) out.push(c);
  }
  return out;
}

/* ===========================
   Game start & reset
   =========================== */
function startNewGame(){
  stopSpeech();
  isGameOver=false; direction=1; playerHand=[]; computerHand=[]; discard={pile:[], currentColor:null};
  buildDeck();
  for(let i=0;i<START_HAND;i++){ playerHand.push(...drawFromDeck(1)); computerHand.push(...drawFromDeck(1)); }
  // starter card (avoid wildDraw4 start)
  let starter = drawFromDeck(1)[0];
  while(starter && starter.kind === 'wildDraw4'){ deck.unshift(starter); starter = drawFromDeck(1)[0]; }
  if(!starter) starter = {kind:'number', color:COLORS[0], value:0, img:`photos/photo1.jpg`};
  discard.pile.push(starter); discard.currentColor = starter.color || COLORS[Math.floor(Math.random()*COLORS.length)];
  // starter effects (optional simplified)
  if(starter.kind === 'action' && starter.value === 'draw2'){ playerHand.push(...drawFromDeck(2)); if(statusText) statusText.textContent='draw two since you drew two bahaha'; }
  else if(statusText) statusText.textContent='game has started xx';
  currentPlayer='player';
  updateUI();
  if(endOverlay) endOverlay.style.display='none';
  if(app) app.style.display='flex';
}

/* ===========================
   UI Rendering
   Defensive: check elements exist before setting textContent
   =========================== */
function updateUI(){
  if(deckCount) deckCount.textContent = deck.length;
  // draw pile back image
  if(drawPileDiv && drawPileDiv.querySelector) {
    const imgEl = drawPileDiv.querySelector('img');
    if(imgEl) imgEl.src = `photos/photo1.jpg`;
  }

  // discard top
  if(discardDiv){
    discardDiv.innerHTML = '';
    const top = discard.pile.length ? discard.pile[discard.pile.length-1] : null;
    if(top){
      const img = document.createElement('img'); img.src = top.img; img.alt='top';
      discardDiv.appendChild(img);
      // badge (color & value)
      const badge = document.createElement('div'); badge.id='discardBadge';
      badge.textContent = top.kind === 'number' ? top.value : (top.kind==='action' ? actionLabel(top.value) : (top.kind==='wildDraw4' ? 'W+4' : 'W'));
      const effectiveColor = discard.currentColor || top.color || null;
      if(effectiveColor){
        badge.style.background = colorToGradient(effectiveColor);
        badge.style.color = (effectiveColor === 'yellow') ? '#042027' : '#fff';
      } else { badge.style.background = '#000'; badge.style.color = '#fff'; }
      badge.style.position = 'absolute'; badge.style.right='6px'; badge.style.bottom='6px'; badge.style.padding='6px 8px'; badge.style.borderRadius='8px'; badge.style.fontWeight='800'; badge.style.fontSize='13px';
      discardDiv.appendChild(badge);
    } else {
      discardDiv.innerHTML = '<div style="padding:8px;color:#ddd">No discard</div>';
    }
  }

  // player hand
  if(playerHandDiv){
    playerHandDiv.innerHTML = '';
    for(let i=0;i<playerHand.length;i++){
      const c = playerHand[i];
      const cardEl = document.createElement('div'); cardEl.className='card';
      const im = document.createElement('img'); im.src = c.img; im.alt='card'; cardEl.appendChild(im);
      const ov = document.createElement('div'); ov.className='overlay';
      if(c.kind === 'number'){ ov.textContent = c.value; ov.style.background = c.color; ov.style.color = (c.color==='yellow'?'#042027':'#fff'); }
      else if(c.kind === 'action'){ ov.textContent = actionLabel(c.value); ov.style.background = c.color; ov.style.color = (c.color==='yellow'?'#042027':'#fff'); }
      else if(c.kind === 'wild'){ ov.textContent = 'W'; ov.style.background = '#fff'; ov.style.color='#000'; }
      else if(c.kind === 'wildDraw4'){ ov.textContent = 'W+4'; ov.style.background = '#fff'; ov.style.color='#000'; }
      ov.style.padding='6px 8px'; ov.style.borderRadius='8px'; ov.style.fontWeight='800';
      cardEl.appendChild(ov);
      if(isPlayable(c)) cardEl.classList.add('playable');
      cardEl.addEventListener('click', ()=> {
        if(currentPlayer !== 'player' || isGameOver) return;
        if(isPlayable(c)){
          if(c.kind === 'wild' || c.kind === 'wildDraw4'){
            pendingWildPlay = { card:c, from:'player', idx:i };
            showColorPicker();
          } else playCardFromHand('player', i);
        } else {
          cardEl.animate([{ transform:'translateY(0)'},{transform:'translateY(-8px)'},{transform:'translateY(0)'}],{duration:260});
          playTone(240,0.06,'sine',0.09);
        }
      });
      playerHandDiv.appendChild(cardEl);
    }
  }

  // computer hand (face-down)
  if(computerHandDiv){
    computerHandDiv.innerHTML = '';
    for(let i=0;i<computerHand.length;i++){
      const cdiv = document.createElement('div'); cdiv.className='computer-card';
      cdiv.style.backgroundImage = `url('photos/photo1.jpg')`;
      computerHandDiv.appendChild(cdiv);
    }
  }

  if(turnTag) turnTag.textContent = (currentPlayer==='player' ? 'My YAB xx (my love xx)' : 'AI robot loser heheh xx');
}

/* convert color name to decent badge gradient */
function colorToGradient(color){
  if(color==='red') return 'linear-gradient(180deg,#ff7b7b,#e64545)';
  if(color==='yellow') return 'linear-gradient(180deg,#ffe08a,#ffd166)';
  if(color==='green') return 'linear-gradient(180deg,#85ffb7,#29be6a)';
  return 'linear-gradient(180deg,#8fb6ff,#1e7bff)'; // blue
}
function actionLabel(val){ if(val==='draw2') return '+2'; if(val==='reverse') return '↺'; return '⦸'; }

/* ===========================
   Play logic
   =========================== */
function topCard(){ return discard.pile.length ? discard.pile[discard.pile.length-1] : null; }
function isPlayable(card){
  const top = topCard();
  if(!top) return true;
  if(card.kind === 'wild' || card.kind === 'wildDraw4') return true;
  if(discard.currentColor){
    if(card.color === discard.currentColor) return true;
  }
  if(top.kind === 'number' && card.kind === 'number' && card.value === top.value) return true;
  if(card.color === top.color) return true;
  if(card.kind === 'action' && top.kind === 'action' && card.value === top.value) return true;
  return false;
}

function playCardFromHand(who, idx){
  const hand = (who==='player') ? playerHand : computerHand;
  const card = hand.splice(idx,1)[0];
  discard.pile.push(card);
  discard.currentColor = card.color || null;
  animatePlay(card, who);
  soundPlayCard();
  setTimeout(()=>{
    applyCardEffect(card, who);
    updateUI();
    checkWin();
  }, 360);
}

/* finalize wild played by player with chosen color */
function playWildFinalize(card, from, chosenColor, idx){
  if(from === 'player'){
    const foundIdx = playerHand.findIndex(c=>c.id===card.id);
    if(foundIdx !== -1) playerHand.splice(foundIdx,1);
  }
  discard.pile.push(card);
  discard.currentColor = chosenColor;
  animatePlay(card, from);
  soundSpecial();
  setTimeout(()=>{ applyCardEffect(card, from); updateUI(); checkWin(); }, 360);
}

/* apply effects (skip/reverse/draw2/wildDraw4) and handle turn switching */
function applyCardEffect(card, playedBy){
  if(card.kind === 'number'){
    currentPlayer = (playedBy === 'player') ? 'computer' : 'player';
    if(statusText) statusText.textContent = `${currentPlayer==='player' ? 'Your' : "ai bots"} turn`;
  } else if(card.kind === 'action'){
    if(card.value === 'skip'){
      if(statusText) statusText.textContent = `${(playedBy==='player') ? 'ai bot has' : 'You'} skipped!`;
      soundSpecial();
      currentPlayer = playedBy;
    } else if(card.value === 'reverse'){
      if(statusText) statusText.textContent = 'Reverse xx means da reversa xx!';
      soundSpecial();
      currentPlayer = playedBy;
    } else if(card.value === 'draw2'){
      const otherHand = (playedBy === 'player') ? computerHand : playerHand;
      const drawn = drawFromDeck(2); otherHand.push(...drawn);
      if(statusText) statusText.textContent = `${(playedBy==='player') ? 'Bot robot xx' : 'my yab xx'} draw 2 and skip!`;
      soundDraw();
      currentPlayer = playedBy;
    }
  } else if(card.kind === 'wild'){
    if(statusText) statusText.textContent = `${playedBy==='player' ? 'You' : 'Computer'} played Wild (${discard.currentColor})`;
    soundSpecial();
    currentPlayer = (playedBy === 'player') ? 'computer' : 'player';
  } else if(card.kind === 'wildDraw4'){
    const otherHand = (playedBy === 'player') ? computerHand : playerHand;
    const drawn = drawFromDeck(4); otherHand.push(...drawn);
    if(statusText) statusText.textContent = `${(playedBy==='player') ? 'Computer' : 'You'} draw 4 and skip!`;
    soundSpecial();
    currentPlayer = playedBy;
  }

  updateUI();
  if(!isGameOver && currentPlayer === 'computer') setTimeout(computerPlayTurn, 700 + Math.random()*900);
}

/* ===========================
   Animations
   =========================== */
function animatePlay(card, who){
  const flyer = document.createElement('img');
  flyer.src = card.img; flyer.style.position='fixed';
  flyer.style.width='90px'; flyer.style.height='120px'; flyer.style.objectFit='cover';
  flyer.style.zIndex = 120; flyer.style.borderRadius='10px'; flyer.style.boxShadow='0 20px 50px rgba(0,0,0,.6)';
  document.body.appendChild(flyer);
  const fromRect = (who==='player') ? playerHandDiv.getBoundingClientRect() : computerHandDiv.getBoundingClientRect();
  const toRect = discardDiv.getBoundingClientRect();
  flyer.style.left = (fromRect.left + fromRect.width/2 - 45)+'px';
  flyer.style.top = (fromRect.top + fromRect.height/2 - 60)+'px';
  flyer.animate([{ transform:'translateY(0) scale(1.05)' },{ transform:'translateY(-6px) scale(1.02)' },{ transform:'translateY(0) scale(.98)' }],{duration:180});
  flyer.animate([{ left:flyer.style.left, top:flyer.style.top, opacity:1 },{ left:(toRect.left + toRect.width/2 - 45)+'px', top:(toRect.top + toRect.height/2 - 60)+'px', opacity:1 }],{duration:360, easing:'ease'});
  setTimeout(()=>{ flyer.remove(); updateUI(); }, 420);
}

/* ===========================
   Drawing
   =========================== */
function playerDraw(n=1, reveal=true){
  const drawn = drawFromDeck(n);
  if(drawn.length){ playerHand.push(...drawn); soundDraw(); updateUI(); } else if(statusText) statusText.textContent='Deck empty';
  currentPlayer = 'computer';
  setTimeout(computerPlayTurn, 700);
}

/* ===========================
   Computer AI
   =========================== */
function computerPlayTurn(){
  if(isGameOver || currentPlayer!=='computer') return;
  if(statusText) statusText.textContent = "AI robot is thinking of a move xx";
  setTimeout(()=>{
    const playable = computerHand.map((c,i)=>({c,i})).filter(x=>isPlayable(x.c));
    if(playable.length){
      const top = topCard();
      let chosenIndex = null;
      if(top && top.kind==='number'){ const exact = playable.find(x=>x.c.kind==='number' && x.c.value===top.value); if(exact) chosenIndex = exact.i; }
      if(chosenIndex===null && discard.currentColor){ const colMatch = playable.find(x=>x.c.color===discard.currentColor); if(colMatch) chosenIndex = colMatch.i; }
      if(chosenIndex===null){ const act = playable.find(x=>x.c.kind==='action'); if(act) chosenIndex = act.i; }
      if(chosenIndex===null){ const wild = playable.find(x=>x.c.kind==='wild'); if(wild) chosenIndex = wild.i; }
      if(chosenIndex===null){ const w4 = playable.find(x=>x.c.kind==='wildDraw4'); if(w4) chosenIndex = w4.i; }
      if(chosenIndex===null) chosenIndex = playable[0].i;

      const chosenCard = computerHand[chosenIndex];
      if(chosenCard.kind==='wild' || chosenCard.kind==='wildDraw4'){
        const counts = {red:0,yellow:0,green:0,blue:0};
        computerHand.forEach(c=>{ if(c.color) counts[c.color]++; });
        let best='red', bestVal=-1; for(const k of COLORS){ if(counts[k]>bestVal){ bestVal=counts[k]; best=k; } }
        computerHand.splice(chosenIndex,1);
        discard.pile.push(chosenCard); discard.currentColor = best;
        animatePlay(chosenCard,'computer'); soundSpecial(); applyCardEffect(chosenCard,'computer');
      } else {
        playCardFromHand('computer', chosenIndex);
      }
    } else {
      const drawn = drawFromDeck(1);
      if(drawn.length){
        computerHand.push(...drawn); soundDraw(); updateUI();
        const last = computerHand[computerHand.length-1];
        if(isPlayable(last)){
          if(last.kind==='wild' || last.kind==='wildDraw4'){
            const counts = {red:0,yellow:0,green:0,blue:0};
            computerHand.forEach(c=>{ if(c.color) counts[c.color]++; });
            let best='red', bestVal=-1; for(const k of COLORS){ if(counts[k]>bestVal){ bestVal=counts[k]; best=k; } }
            computerHand.pop(); discard.pile.push(last); discard.currentColor = best; animatePlay(last,'computer'); soundSpecial(); applyCardEffect(last,'computer');
          } else playCardFromHand('computer', computerHand.length-1);
        } else { currentPlayer='player'; updateUI(); if(statusText) statusText.textContent='Your turn'; }
      } else { currentPlayer='player'; if(statusText) statusText.textContent='Deck empty — your turn'; }
    }
  }, 700 + Math.random()*800);
}

/* ===========================
   Endgame & Helpers
   =========================== */
function checkWin(){
  if(playerHand.length===0){ isGameOver=true; endTitle.textContent='You Win yuppiesss '; endSubtitle.textContent='i hope you like this version better yabbb xx and i love you moreee xx'; endOverlay.style.display='flex'; soundSpecial(); speak('You win my loveee xx heheh im using this AI Voice bot idk why hahaha xx im just testing itttt '); }
  else if(computerHand.length===0){ isGameOver=true; endTitle.textContent='AI Bot wins nooo yabbb xx'; endSubtitle.textContent="YABB nooo xx have another gooo xx"; endOverlay.style.display='flex'; soundSpecial(); speak('Computer wins'); }
  else updateUI();
}
function showColorPicker(){ if(colorPicker) colorPicker.style.display='block'; }
function hideColorPicker(){ if(colorPicker) colorPicker.style.display='none'; }
function playWildFinalize(card, from, chosenColor, idx){
  if(from==='player'){
    const found = playerHand.findIndex(c=>c.id===card.id);
    if(found!==-1) playerHand.splice(found,1);
  }
  discard.pile.push(card); discard.currentColor = chosenColor; animatePlay(card, from); soundSpecial();
  setTimeout(()=>{ applyCardEffect(card, from); updateUI(); checkWin(); }, 360);
}
function stopSpeech(){ if(window.speechSynthesis) window.speechSynthesis.cancel(); }

/* ===========================
   Startup slideshow -> start
   =========================== */
let slideIndex = 1;
function runStartupSlideshow(){
  const total = TOTAL_PHOTOS;
  const interval = 90;
  const timer = setInterval(()=>{
    const idx = ((slideIndex-1) % total) + 1;
    flashImg.src = `photos/photo${idx}.jpg`;
    slideIndex++;
    if(slideIndex > total){
      clearInterval(timer);
      startupTitle.style.opacity = 1; startupTitle.style.transform='translateY(0)';
      setTimeout(()=>{ startup.style.opacity=0; setTimeout(()=>{ startup.style.display='none'; app.style.display='flex'; startNewGame(); }, 900); }, 1400);
    }
  }, interval);
}

/* ===========================
   init
   =========================== */
window.addEventListener('load', ()=>{
  app.style.display='none';
  endOverlay.style.display='none';
  runStartupSlideshow();
  document.addEventListener('contextmenu', e=>{ if(e.target.tagName==='IMG') e.preventDefault(); });
});
document.addEventListener('pointerdown', ()=> { if(audioCtx.state==='suspended') audioCtx.resume(); }, { once:true });
</script>
</body>
</html>
